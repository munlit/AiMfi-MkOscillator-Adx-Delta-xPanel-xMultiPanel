/// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
/// â•‘	Globals							â•‘
/// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
/// â•‘	AI Adaptive Money Flow Index	â•‘
/// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
/// â•‘	Tsi & Divergences				â•‘
/// â•‘	@	Allen.						â•‘
/// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

//@version=5
indicator(title							= 'AI Mfi & Multi Tsi & Panel Mtf [ğŸ± Allen ã”¬]',
		  shorttitle					= 'Mfi & MTsi & Panel',
		//   overlay						= false,
		// //   precision					= 2,
		  format						= format.price,
		  precision						= 4
		//   explicit_plot_zorder			= true
		  )

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Colors
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

AmeTrBlueFrost							= #E1EEF9
AmeTrGrayNickel							= #F1F1F1
GraySwebSecondaryText					= #77708A
ARoPrimary								= #0035FF
MongoSky10								= #E3FCF7
BrLiYel10								= #FBFD73
BrLiYel40								= #FEF301
VictSecFucsia50							= #EA1889
PlatziGreen30							= #ADEB42
PlatziBlue50							= #24385B
PlatziBlue70							= #121F3D
PlatziBlue80							= #0C1633
UltrRose20								= #FFA3E3
AllenSky10								= #CCF8FF
AllenMint60								= #33FFAC
AllenFucsia50							= #EA1889

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Types
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

strGlobalTimeFrame						= input.string 	(defval = "Grafico",	title = "Timeframe",	group = "Global Timeframe",
			  options					=				["Grafico", "5 min", "15 min", "30 min", "1 Hora", "2 Horas", "3 Horas", "4 Horas"])
insGlobalTFCoefficient					= input.int		(defval = "2",			title = "Coef",			group = "Global Timeframe",				minval = "1",	maxval = "5",	step = 1)

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Types
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

type globalTypeOHL
		float O							= open
		float H							= high
		float L							= low
		float C							= close
		float V							= volume
		int   I							= bar_index

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Functions
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/// â”€â”€â”€ function timeframe
FunGlobalTimeFrame(_timeframe) =>
	switch _timeframe
		"Grafico"						=> "Chart"
		"5 min"							=> "5"
		"15 min"						=> "15"
		"30 min"						=> "30"
		"1 Hora"						=> "60"
		"2 Horas"						=> "120"
		"3 Horas"						=> "180"
		"4 Horas"						=> "240"

/// â”€â”€â”€ function location vertical
FunGlobalVertical(_vertical) =>
	switch _vertical
		"arriba"						=> "top"
		"medio"							=> "middle"
		"abajo"							=> "bottom"

/// â”€â”€â”€ function location horizontal
FunGlobalHorizontal(_horizontal) =>
	switch _horizontal

		"izquierda"						=> "left"
		"centro"						=> "center"
		"derecha"						=> "right"

/// â”€â”€â”€ function position
FunGlobalPosition(_position) =>
	switch _position
		"Externo"						=> "outside"
		"Interno"						=> "inside"

/// â”€â”€â”€ function text size
FunGlobalTextSize(_textsize) =>
	switch _textsize
		"Mini"							=> size.tiny
		"PequeÃ±o"						=> size.small
		"Normal"						=> size.normal
		"Grande"						=> size.large
		"Enorme"						=> size.huge
		"Auto"							=> size.auto

/// â”€â”€â”€ function line style
FunGlobalLineStyle(_linestyle) =>
	switch _linestyle
		'â¯â¯â¯â¯'							=> line.style_solid
		'----'							=> line.style_dashed
		'Â·Â·Â·Â·'							=> line.style_dotted

/// â”€â”€â”€ function Days of Week
FunGlobalDayofWeek(_days) =>
	switch _days
		1								=> 'Domingo'
		2								=> 'Lunes'
		3								=> 'Martes'
		4								=> 'Miercoles'
		5								=> 'Jueves'
		6								=> 'Viernes'
		7								=> 'Sabado'

/// â”€â”€â”€ function Timezone
FunGlobalTimeZone(_timezone) =>
	switch _timezone
		"NYSE"							=> "UTC-5"
		"New York"						=> "America/New_York"
		"Chicago"						=> "America/Chicago"
		"Londres"						=> "Europe/London"
		"Tokyo"							=> "Asia/Tokyo"
		"Shanghai"						=> "Asia/Shanghai"
		"Sydney"						=> "Australia/Sydney"
		"Argentina"						=> "America/Argentina/Buenos_Aires"


/// â”€â”€â”€ function calculate MA
FunGlobalCalculateMA(_source, _length, _type) =>
	switch _type
		"SMA"							=> ta.sma	(_source, _length)
		"HMA"							=> ta.hma	(_source, _length)
		"EMA"							=> ta.ema	(_source, _length)
		"SMMA"							=> ta.rma	(_source, _length)
		"WMA"							=> ta.wma	(_source, _length)
		"VWMA"							=> ta.vwma	(_source, _length)

/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Instances
/// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

gblohl									= globalTypeOHL.new()

/// Instance function timeframe
// FunGlobalTimeFrame(strGlobalTimeFrame)

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
/// â•‘	AI Adaptative MFI				â•‘
/// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

adapMonToolAdj				= "Ajusta el MFI en su lugar para que los niveles de Sobrecompra, Sobreventa y Neutral permanezcan fijos"
adapMonToolMlt				= "Aumente esto para que los nÃºmeros de clasificaciÃ³n aparezcan mÃ¡s lejos del grÃ¡fico del oscilador"

adapMonGrpSet				= "Configuracion FMI"
adapMonGrpLim				= "Clustering Setting"
adapMonGrpApar				= "Apariencia"

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Adaptive Money
/// â”€â”€â”€ Vars â”€â”€â”€â”€â”€â”€â”€â”€â”€
//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

adapMonVarSRC				= input.source	(defval = hlc3,	title = "Fuente MFI",										group = adapMonGrpSet)
adapMonVarLENGTH			= input.int		(defval = 14,	title = "Longitud MFI",							minval = 1,	group = adapMonGrpSet)
adapMonVarDataLength		= input.int		(defval = 300,	title = "TamaÃ±o de datos de entrenamiento",		minval = 1,	group = adapMonGrpLim)
adapMonVarIterations		= input.int		(defval = 5,	title = "Cantidad de iteraciones por barra",	minval = 1,	group = adapMonGrpLim)
adapMonVarOverbought		= input.float	(defval = 80.0,	title = "Inicio de Sobre Compra",							group = adapMonGrpLim)
adapMonVarNeutral			= input.float	(defval = 50.0,	title = "Neutral",											group = adapMonGrpLim)
adapMonVarOversold			= input.float	(defval = 20.0,	title = "Inicio de Sobre Venta",							group = adapMonGrpLim)

adapMonVarADJ				= input.bool	(defval = true,	title = "Usar MFI ajustado",								group = adapMonGrpApar,		tooltip = adapMonToolAdj)
adapMonVarMLT				= input.float	(defval = 1.0,	title = "Multiplicador",									group = adapMonGrpApar,		tooltip = adapMonToolMlt)
adapMonColorLong			= input.color	(AllenMint60,	title = "Compra",											group = adapMonGrpApar)
adapMonColorShort			= input.color	(AllenSky10,	title = "Venta",											group = adapMonGrpApar)

adapMonVaExAA				= adapMonVarOverbought
adapMonVaExBB				= adapMonVarNeutral
adapMonVaExCC				= adapMonVarOversold

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Adaptive Money
/// â”€â”€â”€ Functions â”€â”€â”€â”€
//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

adapMonVarOSC				= ta.mfi(adapMonVarSRC, adapMonVarLENGTH)

var adapMonArrOB			= array.new_float(1, adapMonVarOverbought)
var adapMonArrNE			= array.new_float(1, adapMonVarNeutral)
var adapMonArrOS			= array.new_float(1, adapMonVarOversold)

if nz(adapMonVarOSC) > 0
	for j = adapMonVarIterations to 1

		adapMonArrOB.clear()
		adapMonArrNE.clear()
		adapMonArrOS.clear()

		for i = adapMonVarDataLength to 0

			if math.abs(adapMonVarOSC[i] - adapMonVaExBB) < math.abs(adapMonVarOSC[i] - adapMonVaExAA) and math.abs(adapMonVarOSC[i] - adapMonVaExBB) < math.abs(adapMonVarOSC[i] - adapMonVaExCC)
				adapMonArrNE.push(adapMonVarOSC[i])

			if math.abs(adapMonVarOSC[i] - adapMonVaExAA) < math.abs(adapMonVarOSC[i] - adapMonVaExBB) and math.abs(adapMonVarOSC[i] - adapMonVaExAA) < math.abs(adapMonVarOSC[i] - adapMonVaExCC)
				adapMonArrOB.push(adapMonVarOSC[i])

			if math.abs(adapMonVarOSC[i] - adapMonVaExCC) < math.abs(adapMonVarOSC[i] - adapMonVaExAA) and math.abs(adapMonVarOSC[i] - adapMonVaExCC) < math.abs(adapMonVarOSC[i] - adapMonVaExBB)
				adapMonArrOS.push(adapMonVarOSC[i])
		
		adapMonVaExAA		:= array.avg(adapMonArrOB)
		adapMonVaExBB		:= array.avg(adapMonArrNE)
		adapMonVaExCC		:= array.avg(adapMonArrOS)

adapMonArrNE_NEW			= array.avg(adapMonArrNE)
adapMonArrOB_NEW			= array.avg(adapMonArrOB)
adapMonArrOS_NEW			= array.avg(adapMonArrOS)

positionBetweenBands		= 100 * ((adapMonVarOSC - adapMonArrOS_NEW)/(adapMonArrOB_NEW - adapMonArrOS_NEW))

adapMonIfVAL				= adapMonVarADJ ? positionBetweenBands : adapMonVarOSC

adapMonFuncST				= ta.stdev(adapMonIfVAL, adapMonVarLENGTH)

adapMonIfCOLOR100			= adapMonVarOSC > adapMonArrNE_NEW ? color.new(adapMonColorLong, 90) : color.new(adapMonColorShort, 90)
adapMonIfCOLOR0				= adapMonVarOSC > adapMonArrNE_NEW ? color.new(adapMonColorLong, 0) : color.new(adapMonColorShort, 0)

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Adaptive Money
/// â”€â”€â”€ Display â”€â”€â”€â”€â”€â”€
//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

adapMonPlotMAIN		= plot	(adapMonIfVAL,						color = adapMonIfCOLOR100)
adapMonPlotMID		= plot	(adapMonVarADJ ? adapMonVarNeutral : adapMonArrNE_NEW,		color = adapMonIfCOLOR100)

plot				(adapMonVarADJ ? 100 : adapMonArrOB_NEW,	color =  color.from_gradient(adapMonVarOSC, adapMonArrNE_NEW, adapMonVarADJ ? 100 : adapMonArrOB_NEW, color.new(color.gray, 70), color.new(adapMonColorShort, 0)), linewidth = 6)
plot				(adapMonVarADJ ? 0 : adapMonArrOS_NEW,		color = color.from_gradient(adapMonVarOSC, adapMonVarADJ ? 0 : adapMonArrOS_NEW, adapMonArrNE_NEW, color.new(adapMonColorLong, 0), color.new(color.gray, 70)), linewidth = 6)

// plotchar			(math.abs(adapMonVarOSC - adapMonArrNE_NEW) < math.abs(adapMonVarOSC - adapMonArrOB_NEW) and math.abs(adapMonVarOSC - adapMonArrNE_NEW) < math.abs(adapMonVarOSC - adapMonArrOS_NEW) ? adapMonIfVAL + (adapMonVarOSC > adapMonArrNE_NEW ? adapMonFuncST*adapMonVarMLT : -adapMonFuncST*adapMonVarMLT) : na, "Lateral", "â•â•", location.absolute, adapMonIfCOLOR0)
// plotchar			(math.abs(adapMonVarOSC - adapMonArrOB_NEW) < math.abs(adapMonVarOSC - adapMonArrNE_NEW) and math.abs(adapMonVarOSC - adapMonArrOB_NEW) < math.abs(adapMonVarOSC - adapMonArrOS_NEW) ? adapMonIfVAL + (adapMonVarOSC > adapMonArrNE_NEW ? adapMonFuncST*adapMonVarMLT : -adapMonFuncST*adapMonVarMLT) : na, "Tendencia Alcista", "â”€â”€", location.absolute, adapMonIfCOLOR0)
// plotchar			(math.abs(adapMonVarOSC - adapMonArrOS_NEW) < math.abs(adapMonVarOSC - adapMonArrOB_NEW) and math.abs(adapMonVarOSC - adapMonArrOS_NEW) < math.abs(adapMonVarOSC - adapMonArrNE_NEW) ? adapMonIfVAL + (adapMonVarOSC > adapMonArrNE_NEW ? adapMonFuncST*adapMonVarMLT : -adapMonFuncST*adapMonVarMLT) : na, "Tendencia Bajista", "â”€â”€", location.absolute, adapMonIfCOLOR0)

plotchar			(ta.crossunder(adapMonVarOSC, adapMonArrOB_NEW) ? (adapMonVarADJ ? 100 : adapMonArrOB_NEW) + 10 : na,	"CorrecciÃ³n Venta",		"â–¼",	location.absolute, adapMonColorShort, size = size.tiny)
plotchar			(ta.crossover(adapMonVarOSC, adapMonArrOS_NEW) ? (adapMonVarADJ ? 0 : adapMonArrOS_NEW) - 10 : na,		"CorrecciÃ³n Compra",	"â–²",	location.absolute, adapMonColorLong, size = size.tiny)

fill				(adapMonPlotMID, adapMonPlotMAIN, color = adapMonIfCOLOR100, title = "Area de Tendencia")
fill				(adapMonPlotMID, adapMonPlotMAIN, adapMonIfVAL, adapMonVarADJ ? 50 : adapMonArrNE_NEW, color.new(chart.bg_color, 1000), adapMonVarOSC > adapMonArrNE_NEW ? adapMonColorLong : adapMonColorShort)

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/// â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
/// â•‘  Tsi & Divergences				â•‘
/// â•‘  @	Allen.						â•‘
/// â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Vars â”€â”€â”€
//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/// â”€â”€â”€ Colors â”€â”€â”€
colorTsiMuDiBaseBull		= PlatziGreen30
colorTsiMuDiBaseBear		= VictSecFucsia50

colorTsiMuDiBull			= color.new(AllenMint60,		0)
colorTsiMuDiBear			= color.new(AllenSky10,			0)
colorTsiMuDiDiverBull		= color.new(PlatziGreen30,		0)
colorTsiMuDiDiverBear		= color.new(VictSecFucsia50,	0)
colorTsiMuDiHiddenBull		= color.new(AllenMint60,		55)
colorTsiMuDiHiddenBear		= color.new(AllenSky10,			55)
colorTsiMuDiText			= color.new(PlatziBlue70,		0)
colorTsiMuDiNone			= color.new(AllenSky10,			100)
colorTsiMuDiTSI				= color.new(AllenSky10,			20)

/// â”€â”€â”€ Inputs â”€â”€â”€
vTsiMuDiLong				= input(defval = 6,		title = 'Longitud de Compra')
vTsiMuDiShort				= input(defval = 13,	title = 'Longitud de Venta')
vTsiMuDiSignal				= input(defval = 4,		title = 'Longitud de la SEÃ‘AL')

price						= close[0]

/// â”€â”€â”€ divergences â”€â”€â”€
vTsiMuDiLBR					= input(defval = 5,		title = 'CorrecciÃ³n a la derecha')
vTsiMuDiLBL					= input(defval = 5,		title = 'CorrecciÃ³n a la izquierda')
vTsiMuDiRangeUpper			= input(defval = 30,	title = 'Rango de correcciÃ³n maximo')
vTsiMuDiRangeLower			= input(defval = 2,		title = 'Rango de correcciÃ³n minimo')

/// â”€â”€â”€ Show â”€â”€â”€
showTsiMuDiPlotBull			= input(defval = true,	title = 'Mostrar Divergencia Alcista')
showTsiMuDiPlotHiddenBull	= input(defval = true,	title = 'Mostrar Divergencia scalp Alcista')
showTsiMuDiPlotBear			= input(defval = true,	title = 'Mostrar Divergencia Bajista')
showTsiMuDiPlotHiddenBear	= input(defval = true,	title = 'Mostrar Divergencia scalp Bajista')
showTsiMuDiCloudOn			= input(defval = true,	title = 'TSI Cloud')
showTsiMuDiTSI				= input(defval = false,	title = 'TSI')

tsiMuDiMultiGroup			=				"Mostrar Multi Tsi"
showTsiMuDiTSIPanelTimeF	= input.bool	(true,				title = "Tsi",					group = tsiMuDiMultiGroup)
showTsiMuDiTSITF15			= input.bool	(true,				title = "15m",					group = tsiMuDiMultiGroup,		inline = "TF")
showTsiMuDiTSITF30			= input.bool	(true,				title = "30m",					group = tsiMuDiMultiGroup,		inline = "TF")
showTsiMuDiTSITF1h			= input.bool	(true,				title = "1 H",					group = tsiMuDiMultiGroup,		inline = "TF")
showTsiMuDiTSITF2h			= input.bool	(true,				title = "2 H",					group = tsiMuDiMultiGroup,		inline = "tf2")
showTsiMuDiTSITF3h			= input.bool	(true,				title = "3 H",					group = tsiMuDiMultiGroup,		inline = "tf2")
showTsiMuDiTSITF4h			= input.bool	(true,				title = "4 H",					group = tsiMuDiMultiGroup,		inline = "tf2")

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Functions â”€â”€â”€
//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

double_smooth(src, vTsiMuDiLong, vTsiMuDiShort) =>
	fist_smooth = ta.ema(src, vTsiMuDiLong)
	ta.ema(fist_smooth, vTsiMuDiShort)

insTsiMuDiPC						= ta.change(price)
insTsiMuDiDouble_smoothed_price		= double_smooth(insTsiMuDiPC, vTsiMuDiLong, vTsiMuDiShort)
insTsiMuDiDouble_smoothed_abs_price	= double_smooth(math.abs(insTsiMuDiPC), vTsiMuDiLong, vTsiMuDiShort)
insTsiMuDiTsi_value					= 125 * (insTsiMuDiDouble_smoothed_price / insTsiMuDiDouble_smoothed_abs_price) + 50


insTsiMuDiLagLine					= ta.ema(insTsiMuDiTsi_value, vTsiMuDiSignal)

/// â”€â”€â”€ Plot data â”€â”€â”€
insTsiMuDiFillColor					= showTsiMuDiCloudOn and insTsiMuDiTsi_value > insTsiMuDiLagLine ? colorTsiMuDiDiverBull : showTsiMuDiCloudOn and insTsiMuDiTsi_value <= insTsiMuDiLagLine ? colorTsiMuDiDiverBear : na

plot(insTsiMuDiTsi_value,			color = color.new(PlatziBlue70, 60),	linewidth = 6)
plot(ta.ema(insTsiMuDiTsi_value,	vTsiMuDiSignal),	color = color.new(PlatziBlue70, 60),	linewidth = 6)

insTsiMuDiLine1						= plot(insTsiMuDiTsi_value,	color = color.new(insTsiMuDiFillColor, 30),	linewidth = 2)
insTsiMuDiLine2						= plot(ta.ema(insTsiMuDiTsi_value,	vTsiMuDiSignal),	color = color.new(insTsiMuDiFillColor, 30),	linewidth = 2)

/// â”€â”€â”€ Color fill â”€â”€â”€
insTsiMuDiCloudColor				= showTsiMuDiCloudOn and insTsiMuDiTsi_value > insTsiMuDiLagLine ? colorTsiMuDiBaseBull : showTsiMuDiCloudOn and insTsiMuDiTsi_value <= insTsiMuDiLagLine ? colorTsiMuDiBaseBear : na

fill(insTsiMuDiLine1,	insTsiMuDiLine2,	color = color.new(insTsiMuDiCloudColor, 70))

insTsiMuDiOSC						= insTsiMuDiTsi_value 

// /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// strTsiMuDiTimeFrame					= input.string 	(defval = "Grafico",	title = "Timeframe",	options = ["Grafico", "5 min", "15 min", "30 min", "1 Hora", "2 Horas", "3 Horas", "4 Horas"])
// insTsiMuDiTFCoef					= input.int		(defval = "2", title = "Coef", minval = "1", maxval = "5", step = 1)

// FunTsiMuDiTimeFrame(timeframe)	=>
// 	switch timeframe
// 		"Grafico"					=> "Chart"
// 		"5 min"						=> "5"
// 		"15 min"					=> "15"
// 		"30 min"					=> "30"
// 		"1 Hora"					=> "60"
// 		"2 Horas"					=> "120"
// 		"3 Horas"					=> "180"
// 		"4 Horas"					=> "240"

// /// Instance function
// // FunTsiMuDiTimeFrame(strTsiMuDiTimeFrame)

// /// Structure Timeframe * coefficient
// insTsiMuDiTsi_value					= 125 * (insTsiMuDiDouble_smoothed_price / insTsiMuDiDouble_smoothed_abs_price) + 50

// iTsiMudiTfPeriod					= strTsiMuDiTimeFrame == "Grafico" ? insTsiMuDiTFCoef * (str.tonumber(timeframe.period)) : insTsiMuDiTFCoef * (str.tonumber(FunTsiMuDiTimeFrame(strTsiMuDiTimeFrame)))
// iTsiMudiTfPerMinor					= str.tonumber(FunTsiMuDiTimeFrame(strTsiMuDiTimeFrame)) > 250 ? timeframe.period : (str.tostring(iTsiMudiTfPeriod))
// iTsiMudiTfPerMayor					= timeframe.period
// iTsiMudiTfPerString					= timeframe.isdwm ? iTsiMudiTfPerMayor : iTsiMudiTfPerMinor

// insTsiMuDiTsiLine					= request.security(syminfo.tickerid, iTsiMudiTfPerString, insTsiMuDiTsi_value, barmerge.gaps_on)
// insTsiMuDiEmaLine					= ta.ema(insTsiMuDiTsiLine, vTsiMuDiSignal)

// vTsiMuDiTFModTSI					= insTsiMuDiTsiLine

// [arrTsiMuDiTF,	arrTsiMuDiTF_1,	arrTsiMuDiTF_2]	= request.security(syminfo.tickerid,	iTsiMudiTfPerString,	[vTsiMuDiTFModTSI,	vTsiMuDiTFModTSI[1],	vTsiMuDiTFModTSI[2]],	barmerge.gaps_on)

// /// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/// â”€â”€â”€ Multitimeframe Tsi â”€â”€â”€

vTsiMuDiTSI							= insTsiMuDiTsi_value 

/// â”€â”€â”€ TSI timeframes
[arrTsiMuDiTF15,	arrTsiMuDiTF15m_1,	arrTsiMuDiTF15m_2]	= request.security(syminfo.tickerid,	"15",	[vTsiMuDiTSI,	vTsiMuDiTSI[1],	vTsiMuDiTSI[2]],	barmerge.gaps_on)
[arrTsiMuDiTF30,	arrTsiMuDiTF30m_1,	arrTsiMuDiTF30m_2]	= request.security(syminfo.tickerid,	"30",	[vTsiMuDiTSI,	vTsiMuDiTSI[1],	vTsiMuDiTSI[2]],	barmerge.gaps_on)
[arrTsiMuDiTF1h,	arrTsiMuDiTF1h_1,	arrTsiMuDiTF1h_2]	= request.security(syminfo.tickerid,	"60",	[vTsiMuDiTSI,	vTsiMuDiTSI[1],	vTsiMuDiTSI[2]],	barmerge.gaps_on)
[arrTsiMuDiTF2h,	arrTsiMuDiTF2h_1,	arrTsiMuDiTF2h_2]	= request.security(syminfo.tickerid,	"120",	[vTsiMuDiTSI,	vTsiMuDiTSI[1],	vTsiMuDiTSI[2]],	barmerge.gaps_on)
[arrTsiMuDiTF3h,	arrTsiMuDiTF3h_1,	arrTsiMuDiTF3h_2]	= request.security(syminfo.tickerid,	"180",	[vTsiMuDiTSI,	vTsiMuDiTSI[1],	vTsiMuDiTSI[2]],	barmerge.gaps_on)
[arrTsiMuDiTF4h,	arrTsiMuDiTF4h_1,	arrTsiMuDiTF4h_2]	= request.security(syminfo.tickerid,	"240",	[vTsiMuDiTSI,	vTsiMuDiTSI[1],	vTsiMuDiTSI[2]],	barmerge.gaps_on)

/// â”€â”€â”€ Show TSI
// if showTsiMuDiTSIPanelTimeF
swTsiMuDiTSITF						= plot(showTsiMuDiTSIPanelTimeF	? vTsiMuDiTSI	: na,	title = '',	linewidth = 2,	color = colorTsiMuDiTSI)

swTsiMuDiTSITF15					= plot(showTsiMuDiTSIPanelTimeF and showTsiMuDiTSITF15	? arrTsiMuDiTF15	: na,	title = '',	linewidth = 2,	color = colorTsiMuDiTSI)
swTsiMuDiTSITF30					= plot(showTsiMuDiTSIPanelTimeF and showTsiMuDiTSITF30	? arrTsiMuDiTF30	: na,	title = '',	linewidth = 2,	color = colorTsiMuDiTSI)
swTsiMuDiTSITF1h					= plot(showTsiMuDiTSIPanelTimeF and showTsiMuDiTSITF1h	? arrTsiMuDiTF1h	: na,	title = '',	linewidth = 2,	color = colorTsiMuDiTSI)
swTsiMuDiTSITF2h					= plot(showTsiMuDiTSIPanelTimeF and showTsiMuDiTSITF2h	? arrTsiMuDiTF2h	: na,	title = '',	linewidth = 2,	color = colorTsiMuDiTSI)
swTsiMuDiTSITF3h					= plot(showTsiMuDiTSIPanelTimeF and showTsiMuDiTSITF3h	? arrTsiMuDiTF3h	: na,	title = '',	linewidth = 2,	color = colorTsiMuDiTSI)
swTsiMuDiTSITF4h					= plot(showTsiMuDiTSIPanelTimeF and showTsiMuDiTSITF4h	? arrTsiMuDiTF4h	: na,	title = '',	linewidth = 2,	color = colorTsiMuDiTSI)

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Divergences â”€â”€â”€
//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

insTsiMuDiPLFound					= na(ta.pivotlow(insTsiMuDiOSC, vTsiMuDiLBL, vTsiMuDiLBR)) ? false : true
insTsiMuDiPHFound					= na(ta.pivothigh(insTsiMuDiOSC, vTsiMuDiLBL, vTsiMuDiLBR)) ? false : true

FunTsiMuDi_inRange(cond) =>
	insTsiMuDiBars					= ta.barssince(cond == true)
	vTsiMuDiRangeLower				<= insTsiMuDiBars and insTsiMuDiBars <= vTsiMuDiRangeUpper

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Compra regular â”€â”€â”€
//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/// â”€â”€â”€ Osc: Higher Low â”€â”€â”€
tsiDiInsOSCHL						= insTsiMuDiOSC[vTsiMuDiLBR]	> ta.valuewhen(insTsiMuDiPLFound, insTsiMuDiOSC[vTsiMuDiLBR], 1)	and FunTsiMuDi_inRange(insTsiMuDiPLFound[1])
/// â”€â”€â”€ Price: Lower Low â”€â”€â”€
tsiDiInsPRICELL						= low[vTsiMuDiLBR]				< ta.valuewhen(insTsiMuDiPLFound, low[vTsiMuDiLBR], 1)

tsiDiInsBULLCond					= showTsiMuDiPlotBull	and tsiDiInsPRICELL	and tsiDiInsOSCHL	and insTsiMuDiPLFound

plot(insTsiMuDiPLFound ? insTsiMuDiOSC[vTsiMuDiLBR] : na,
			  offset				= -vTsiMuDiLBR,
			  title					= 'Confirmacion de Compra',
			  linewidth				= 2,
			  color					= tsiDiInsBULLCond ? colorTsiMuDiBull : colorTsiMuDiNone)

plotshape(tsiDiInsBULLCond ? insTsiMuDiOSC[vTsiMuDiLBR] : na,
			  offset				= -vTsiMuDiLBR,
			  title					= 'Etiqueta de Compra',
			  text					= ' Compra ',
			  style					= shape.labelup,
			  location				= location.absolute,
			  color					= colorTsiMuDiBull,
			  textcolor				= colorTsiMuDiText)

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Compra scalp â”€â”€â”€
//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/// â”€â”€â”€ Osc: Lower Low â”€â”€â”€
tsiDiInsOSCLL						= insTsiMuDiOSC[vTsiMuDiLBR]	< ta.valuewhen(insTsiMuDiPLFound, insTsiMuDiOSC[vTsiMuDiLBR], 1)	and FunTsiMuDi_inRange(insTsiMuDiPLFound[1])
/// â”€â”€â”€ Price: Higher Low â”€â”€â”€
tsiDiInsPRICEHL						= low[vTsiMuDiLBR]				> ta.valuewhen(insTsiMuDiPLFound, low[vTsiMuDiLBR], 1)

tsiDiInsHiddenBullCond				= showTsiMuDiPlotHiddenBull	and tsiDiInsPRICEHL	and tsiDiInsOSCLL	and insTsiMuDiPLFound

plot(insTsiMuDiPLFound ? insTsiMuDiOSC[vTsiMuDiLBR] : na,
			  offset				= -vTsiMuDiLBR,
			  title					= 'ConfirmaciÃ³n de Compra scalp',
			  linewidth				= 2,
			  color					= tsiDiInsHiddenBullCond ? colorTsiMuDiHiddenBull : colorTsiMuDiNone)

plotshape(tsiDiInsHiddenBullCond ? insTsiMuDiOSC[vTsiMuDiLBR] : na,
			  offset				= -vTsiMuDiLBR,
			  title					= 'Etiqueta de Compra scalp',
			  text					= ' â–³ scalp ',
			  style					= shape.labelup,
			  location				= location.absolute,
			  color					= colorTsiMuDiHiddenBull,
			  textcolor				= colorTsiMuDiText)

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Venta regular â”€â”€â”€
//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/// â”€â”€â”€ Osc: Lower High â”€â”€â”€
tsiDiInsOSCLH						= insTsiMuDiOSC[vTsiMuDiLBR]	< ta.valuewhen(insTsiMuDiPHFound, insTsiMuDiOSC[vTsiMuDiLBR], 1) and FunTsiMuDi_inRange(insTsiMuDiPHFound[1])
/// â”€â”€â”€ Price: Higher High â”€â”€â”€
tsiDiInsPRICEHH						= high[vTsiMuDiLBR]				> ta.valuewhen(insTsiMuDiPHFound, high[vTsiMuDiLBR], 1)

tsiDiInsBEARCond					= showTsiMuDiPlotBear	and tsiDiInsPRICEHH	and tsiDiInsOSCLH	and insTsiMuDiPHFound

plot(insTsiMuDiPHFound ? insTsiMuDiOSC[vTsiMuDiLBR] : na,
			  offset				= -vTsiMuDiLBR,
			  title					= 'ConfirmaciÃ³n de Venta',
			  linewidth				= 2,
			  color					= tsiDiInsBEARCond ? colorTsiMuDiBear : colorTsiMuDiNone)

plotshape(tsiDiInsBEARCond ? insTsiMuDiOSC[vTsiMuDiLBR] : na,
			  offset				= -vTsiMuDiLBR,
			  title					= 'Etiqueta de Venta',
			  text					= ' Venta ',
			  style					= shape.labeldown,
			  location				= location.absolute,
			  color					= colorTsiMuDiBear,
			  textcolor				= colorTsiMuDiText)

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/// â”€â”€â”€ Venta scalp â”€â”€â”€
//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/// â”€â”€â”€ Osc: Higher High â”€â”€â”€
tsiDiInsOSCHH						= insTsiMuDiOSC[vTsiMuDiLBR]	> ta.valuewhen(insTsiMuDiPHFound, insTsiMuDiOSC[vTsiMuDiLBR], 1) and FunTsiMuDi_inRange(insTsiMuDiPHFound[1])
/// â”€â”€â”€ Price: Lower High â”€â”€â”€
tsiDiInsPRICELH						= high[vTsiMuDiLBR]				< ta.valuewhen(insTsiMuDiPHFound, high[vTsiMuDiLBR], 1)

tsiDiInsHiddenBearCond				= showTsiMuDiPlotHiddenBear	and tsiDiInsPRICELH	and tsiDiInsOSCHH	and insTsiMuDiPHFound

plot(insTsiMuDiPHFound ? insTsiMuDiOSC[vTsiMuDiLBR] : na,
			  offset				= -vTsiMuDiLBR,
			  title					= 'ConfirmaciÃ³n de Venta scalp',
			  linewidth				= 2,
			  color					= tsiDiInsHiddenBearCond ? colorTsiMuDiHiddenBear : colorTsiMuDiNone)

plotshape(tsiDiInsHiddenBearCond ? insTsiMuDiOSC[vTsiMuDiLBR] : na,
			  offset				= -vTsiMuDiLBR,
			  title					= 'Etiqueta de Venta scalp',
			  text					= ' â–½ scalp ',
			  style					= shape.labeldown,
			  location				= location.absolute,
			  color					= colorTsiMuDiHiddenBear,
			  textcolor				= colorTsiMuDiText)

//// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
